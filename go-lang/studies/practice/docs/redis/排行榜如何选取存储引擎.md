# 排行榜如何选取存储引擎

---

排行榜的基本操作,查询用户名次/分数,更新用户名次，查询前若干名,删除用户等，有些业务需要用到全部这些接口，有些业务只需要用到其中部分接口（比如更新用户分数、获取前若干名）。我们可选的存储引擎有内存型存储redis,磁盘型存储leveldb,rocksdb等

* redis提供了多种丰富的数据结构，其中的sorted sets(zset)能完全满足我们各接口需求, zset的核心数据结构是哈希表+跳跃表，其中哈希表保存各个用户的分数，跳跃表维护各个分数对应的排名，增加用户分数和查询用户排名的时间复杂度都是LOG(N)，因此适合对性能要求较高的业务使用
* 而leveldb、rocksdb只提供了key、value型接口，为什么也可以在部分业务场景(无需查询用户名次)也可以使用呢? 图八是leveldb架构，从图中可知, leveldb是key都是有序存储的，ssdb就是通过将分数通过一定规则编码也作为一个key写入leveldb以支持redis zset数据结构，不过ssdb的查询排名时间复杂度是O（N）,在生产环境中仅适合不查询用户排名的业务使用，但可以支持查询整个排行榜前N名（N一般小于等于200）。

![](img/rank_1.png)


因此降低成本第一个方法就是根据各业务特点、类型按需选择合适的存储引擎！不需要查询名次的业务可以使用ssdb(leveldb)磁盘性存储引擎！

再看降低成本第二个方法，随着排行榜数越来越多，redis排行榜存储机也逐渐增多，存储机器资源紧张，申请周期长，成本也较高，通过分析线上存量排行榜，发现部分业务具有明显的周期性，如各类业务的活动、赛事排行榜等上线推广时流量较大，活动结束时几乎无流量访问但是又不能清空整个排行榜，对于这类业务，排行榜系统提供了冷热分离机制，将冷数据从redis内存中迁移到ssdb(leveldb)的硬盘中，从而释放宝贵的内存资源，提高机器资源使用率，节省成本。

数据冷热分离方案如图九所示，通过agent采集现网所有排行榜流量，每日定时分析是否有排行榜满足迁移策略（如排行榜用户数大于1万，近两周流量小于某阀值等），若满足策略，就生成迁移任务，记录迁移的排行榜一系列元数据信息，写入MQ。迁移服务轮询MQ,若发现有迁移任务,就开始迁移工作，将全量排行榜数据备份到SSDB(leveldb)存储节点，缩容或清空现网redis排行榜数据，释放内存资源，图十是冷数据、热数据占比分析，冷数据占比高达17%。

![](img/rank_2.png)
